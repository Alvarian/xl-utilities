<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>

        <style>
            .drop-area {
                border: 2px dashed #ccc;
                border-radius: 20px;
                width: 480px;
                font-family: sans-serif;
                margin: 50px auto;
                padding: 20px;
            }
            .drop-area.highlight {
                border-color: purple;
            }
            p {
                margin-top: 0;
            }
            .my-form {
                margin-bottom: 10px;
            }
            #gallery {
                margin-top: 10px;
            }
            #gallery img {
                width: 150px;
                margin-bottom: 10px;
                margin-right: 10px;
                vertical-align: middle;
            }
            .button {
                display: inline-block;
                padding: 10px;
                background: #ccc;
                cursor: pointer;
                border-radius: 5px;
                border: 1px solid #ccc;
            }
            .button:hover {
                background: #ddd;
            }
            #fileElem {
                display: none;
            }

             /* The Modal (background) */
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0,0,0); /* Fallback color */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            }

            /* Modal Content/Box */
            .modal-content {
                background-color: #fefefe;
                margin: 15% auto; /* 15% from the top and centered */
                padding: 20px;
                border: 1px solid #888;
                width: 80%; /* Could be more or less, depending on screen size */
                display: flex;
                flex-direction: column;
                position: relative;
            }

            /* The Close Button */
            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
                position: absolute;
                right: 0;
            }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            } 

            .grid {
                display: grid;
                /* gap: 50px; */
                grid-template-columns: repeat(auto-fit, minmax(540px, 1fr));
            }
        </style>
        <!-- use version 0.19.1 -->
        <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.19.1/package/dist/xlsx.full.min.js"></script>
    </head>
    <body>
        <div class="grid">
            {% for feature in features %}
                <div class="drop-area" ondrop="handleDrop(event, `{{ feature[0] }}`)">
                    <h3>{{ (feature[0].split("_")[0] + " " + feature[0].split("_")[1]).title() }}</h3>
                    <form class="my-form">
                        <p>Upload multiple files with the file dialog or by dragging and dropping images onto the dashed region</p>
                        <input type="file" id="fileElem" multiple accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" onchange="handleFiles(this.files)">
                        <label class="button" for="fileElem">Select some files</label>
                    </form>
                </div>
            {% endfor %}
        </div>

        <!-- The Modal -->
        <div id="myModal" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 id="title"></h3>

                <label for="columns" >Choose Columns to Alter:</label>
                <select name="columns" id="columns" multiple></select> 

                <input type="submit" value="Submit" id="submitBtn" />
            </div>
        </div> 

        <script>
            let dropArea = document.getElementsByClassName('drop-area');
            // Get the <span> element that closes the modal
            let span = document.getElementsByClassName("close")[0];
            // Get the modal
            let modal = document.getElementById("myModal");
            let title = document.getElementById("title");

            let columns = document.getElementById("columns");
            
            function preventDefaults (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                [...dropArea].forEach(x => x.addEventListener(eventName, preventDefaults, false));
            });

            function highlight(e) {
                [...dropArea].forEach(x => x.classList.add('highlight'));
            }
            function unhighlight(e) {
                [...dropArea].forEach(x => x.classList.remove('highlight'));
            }
            ;['dragenter', 'dragover'].forEach(eventName => {
                [...dropArea].forEach(x => x.addEventListener(eventName, highlight, false));
            });
            ;['dragleave', 'drop'].forEach(eventName => {
                [...dropArea].forEach(x => x.addEventListener(eventName, unhighlight, false));
            });

            function handleSubmission(e, file, featureEndpoint) {
                let formData = new FormData();
                const columnsSelected = [...document.getElementsByClassName("column")].filter(x => x.selected).map(x => x.value);
                formData.append('columns_selected', columnsSelected);
                formData.append('file', file);

                let url = `/formatter/${featureEndpoint}`;

                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                    .then((response) => {if (response.ok) return response.blob()})
                    .then((blob) => URL.createObjectURL(blob))
                    .then((href) => {
                        const a = document.createElement("a");
                        document.body.appendChild(a);
                        a.style = "display: none";
                        a.href = href;
                        a.download = file;
                        a.click();
                    })
                    .catch(err => console.log(err))
            }
            async function uploadFile(file, feature) {                
                const data = await file.arrayBuffer();
                let firstSheetName = Object.keys(XLSX.readFile(data).Sheets)[0];
                let ws = XLSX.readFile(data).Sheets[firstSheetName];
                delete ws["!ref"];
                delete ws["!margins"];
                
                for (let cell in ws) {
                    if (cell.split("")[1] !== "1") {
                        break;
                    }
                    let column_selection = document.createElement("option");
                    column_selection.value = ws[cell].v;
                    column_selection.innerText = ws[cell].v;
                    column_selection.className = "column";
                    column_selection.onmousedown = (e) => {
                        e.preventDefault();
                        e.target.selected = !e.target.selected;

                        return false;
                    }
                    columns.appendChild(column_selection);
                }

                title.innerText = firstSheetName;
                modal.style.display = "block";

                const submitBtn = document.getElementById("submitBtn");
                submitBtn.onclick = (e) => handleSubmission(e, file, feature)
            }
            function handleDrop(e, featureName) {
                let dt = e.dataTransfer;
                let files = dt.files;
                
                ([...files]).forEach(x => uploadFile(x, featureName));
            }

            // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
                modal.style.display = "none";
            }

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            } 
        </script>
    </body>
</html>